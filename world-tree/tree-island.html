<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="Adding terrain shapes to the game world">
  <link type="text/css" rel="stylesheet" href="../css/grubbymits.css"/>
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/base16/solarized-dark.min.css" integrity="sha512-JPpsArcPmVD/lHCCuZeG6Kx4x2qURRXHXxKYaXYJiKEKaoLOcXKDYqQ4jSeauXbk+U6uZ1UzrGO85y+lpys0Og==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel='shortcut icon' type='image/x-icon' href='../favicon.ico'>
  <title>Tree Demo</title>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js" integrity="sha512-W7EehcwtSbRF63FIQlXEOOd5mnq0Et0V0nUOvwcUvjnCKgOLLYbqriQxEQSp63sfrkryxIg/A/O8v8O18QwQCQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/languages/javascript.min.js" integrity="sha512-aN2s9TjDSMELiMJg7b24YYNKJxC8nMdL9TzL/t9Yfbiryx1WQCfBgxPQQQYYw6R9b4ehpdQYe2eZCRnvvU972g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>hljs.highlightAll();</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js" integrity="sha512-W7EehcwtSbRF63FIQlXEOOd5mnq0Et0V0nUOvwcUvjnCKgOLLYbqriQxEQSp63sfrkryxIg/A/O8v8O18QwQCQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/languages/javascript.min.js" integrity="sha512-aN2s9TjDSMELiMJg7b24YYNKJxC8nMdL9TzL/t9Yfbiryx1WQCfBgxPQQQYYw6R9b4ehpdQYe2eZCRnvvU972g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>hljs.highlightAll();</script>
  <script type="module" src="demos/trees.js"></script>
  <div style="background-color:#002B36">
    <div class="container">
    <div width="100%" background-position="center"></div>
      <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <img class="img-fluid" src="../assets/images/sweden.jpeg" alt="forest path">
        </div>
      </div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="../index.html">Home</a></li>
          <li class="breadcrumb-item"><a href="./introduction.html">Intro</a></li>
          <li class="breadcrumb-item"><a href="./water.html">Water</a></li>
          <li class="breadcrumb-item"><a href="./biomes.html">Biomes</a></li>
          <li class="breadcrumb-item"><a href="./shapes.html">Shapes</a></li>
          <li class="breadcrumb-item"><a href="./actors.html">Actors</a></li>
          <li class="breadcrumb-item active">Trees</li>
        </ol>
        </nav>
      <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <cb_h1>Placing Trees<br><br></cb_h1>
          <cb_p>
          The island that we've been working on looks rather bare, and it would be usual
          in real life to see a greenish island without some plants on it. So in this demo
          we'll add trees on the island, in sensible places, based on querying the
          TerrainBuilder about the surface conditions.
          <br><br>
          Probably the most important for placing plants is what the biome is, so in our
          example we'll avoid putting trees in the sea or on the beach. We're also going
          to keep it simple by selecting locations at complete random, but a nicer way to
          do it could involve a noise function and selecting tree densities based on each
          biome.
          </cb_p>
          <pre><code class="language-javascript">
function random_inrange(min, max) { 
  return Math.random() * (max - min) + min;
}

function addTrees(totalTrees, terrainDims, context, builder) {
  const treeSheet = new WT.SpriteSheet("demos/graphics/png/trees");
  const treeSpriteWidth = 114;
  const treeSpriteHeight = 171;

  // Ask WorldTree to chop the spritesheet into an array of
  // StaticGraphicComponent.
  const treeGraphics =
    WT.generateStaticGraphics(treeSheet, treeSpriteWidth, treeSpriteHeight,
                              /*xBegin*/0, /*yBegin*/0,
                              /*columns*/8, /*rows*/5);
  const treeDims =
    WT.TwoByOneIsometric.getDimensions(treeSpriteWidth,
                                       treeSpriteHeight);
  let inserted = 0;
  let insertedAt = new Map();
  let attempts = 0;
  const maxAttempts = 1000;
  while (inserted < totalTrees && attempts < maxAttempts) {
    // Choose a random spot on the map and check whether it seems wet
    // enough to support a tree.
    attempts++;
    const x = Math.floor(Math.random() * cellsX);
    const y = Math.floor(Math.random() * cellsY);
    const biome = builder.biomeAt(x, y);
    // Don't place a tree where it would be out of place.
    if (biome == WT.Biome.Beach || biome == WT.Biome.Water) {
      continue;
    }
    // Don't place on a ramp.
    if (!builder.isFlatAt(x, y)) {
      continue;
    }
    // Don't place two trees in the same place.
    if (insertedAt.has(y) && insertedAt.get(y).has(x)) {
      continue;
    } else if (insertedAt.has(y)) {
      insertedAt.get(y).add(x);
    } else {
      insertedAt.set(y, new Set());
      insertedAt.get(y).add(x);
    }

    // Try not the place the tree in the exact same relative spot within a tile.
    let offsetX = random_inrange(treeDims.width / -4, treeDims.width / 4);
    let offsetY = random_inrange(treeDims.depth / -4, treeDims.depth / 4);
    const centreX = Math.floor((x * terrainDims.width) +
                               (terrainDims.width / 2) + offsetX);
    const centreY = Math.floor((y * terrainDims.depth) +
                               (terrainDims.depth / 2) + offsetY);
    const z = terrainDims.height * (1 + builder.relativeHeightAt(x, y));
    const loc = new WT.Point3D(centreX, centreY, z);

    // Choose a random graphic.
    const idx = Math.floor(Math.random() * Math.floor(treeGraphics.length));
    const graphic = treeGraphics[idx];
    const tree = new WT.createGraphicalEntity(context, loc, treeDims, graphic);
    inserted++;
  }
}
          </code></pre>
          <cb_p>
          Our island has now been populated with a bunch of trees, at various heights.
          The code is running in the canva below (if your screen is big enough), so
          use mouse click to move the camera around.<br><br>
          </cb_p>
          <div class="d-none d-sm-block">
            <canvas id="demoCanvas" oncontextmenu="return false;" width="900" height="600">
          </div>
        </div>
      </div>
    </div>
  </div>  
</body>
</html>
